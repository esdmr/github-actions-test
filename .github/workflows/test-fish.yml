name: Test fish scripts

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: Path to executable script
        type: string
        required: true

jobs:
  test-fish:
    strategy:
      fail-fast: false
      matrix:
        include:
          # - fishTag: 3.5.0
          #   fishFile: fish-3.5.0.tar.xz
          #   fishMajor: 3
          # - fishTag: 3.4.0
          #   fishFile: fish-3.4.0.tar.xz
          #   fishMajor: 3
          # - fishTag: 3.3.0
          #   fishFile: fish-3.3.0.tar.xz
          #   fishMajor: 3
          # - fishTag: 3.2.0
          #   fishFile: fish-3.2.0.tar.xz
          #   fishMajor: 3
          # - fishTag: 3.1.0
          #   fishFile: fish-3.1.0.tar.gz
          #   fishMajor: 3
          # - fishTag: 3.0.0
          #   fishFile: fish-3.0.0.tar.gz
          #   fishMajor: 3
          # - fishTag: 2.7.0
          #   fishFile: fish-2.7.0.tar.gz
          #   fishMajor: 2
          # - fishTag: 2.6.0
          #   fishFile: fish-2.6.0.tar.gz
          #   fishMajor: 2
          # - fishTag: 2.5.0
          #   fishFile: fish-2.5.0.tar.gz
          #   fishMajor: 2
          # - fishTag: 2.4.0
          #   fishFile: fish-2.4.0.tar.gz
          #   fishMajor: 2
          # - fishTag: 2.3.0
          #   fishFile: fish-2.3.0.tar.gz
          #   fishMajor: 2
          # - fishTag: 2.2.0
          #   fishFile: fish-2.2.0.tar.gz
          #   fishMajor: 2
          # - fishTag: 2.1.0
          #   fishFile: fish-2.1.0.tar.gz
          #   fishMajor: 2
          - fishTag: 2.0.0
            fishFile: fish-2.0.0.tar.gz
            fishMajor: 2

    runs-on: ubuntu-latest
    name: Fish ${{ matrix.fishTag }} (${{ matrix.fishFile }})

    steps:
      - name: Make installation directory
        run: |-
          mkdir .fish-bin
          echo "$(pwd)/.fish-bin" >> $GITHUB_PATH

      - name: Cache fish build
        uses: actions/cache@c3f1317a9e7b1ef106c153ac8c0f00fed3ddbc0d # tag=v3
        with:
          path: .fish-bin
          key: ${{ runner.OS }}-fish-${{ matrix.fishTag }}-${{ matrix.fishFile }}

      - name: Build fish
        run: |-
          if test -f .fish-bin/fish; then
            cd .fish-bin
            chmod +x fish fish_indent fish_key_reader
            exit
          fi

          wget "https://github.com/fish-shell/fish-shell/releases/download/$FISH_TAG/$FISH_FILE" || exit 1
          tar xf "$FISH_FILE" || exit 2
          ls
          test -d "fish-$FISH_TAG" || exit 3

          cd "fish-$FISH_TAG" || exit 4

          if test "$FISH_MAJOR" -eq "3"; then
            echo v3 detected

            sudo apt install build-essential cmake ncurses-dev libncurses5-dev libpcre2-dev gettext || exit 5

            mkdir build || exit 6
            cd build || exit 7
            cmake .. || exit 8
            make || exit 9
            mv fish fish_indent fish_key_reader ../../.fish-bin || exit 10
          elif test "$FISH_MAJOR" -eq "2"; then
            echo v2 detected

            sudo apt install build-essential ncurses-dev libncurses5-dev gettext autoconf || exit 5

            autoreconf || exit 6
            ./configure || exit 7
            make || exit 9
            mv fish fish_indent fish_key_reader ../.fish-bin || exit 10
          else
            echo Version "$FISH_MAJOR" unknown.
            exit 5
          fi
        env:
          FISH_TAG: ${{ matrix.fishTag }}
          FISH_FILE: ${{ matrix.fishFile }}
          FISH_MAJOR: ${{ matrix.fishMajor }}

      - name: Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3
        with:
          path: .repo

      - name: Test
        run: |-
          chmod +x .repo/fish-tests/${{ github.event.inputs.test_name }}
          ./.repo/fish-tests/${{ github.event.inputs.test_name }}
